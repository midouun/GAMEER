<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø£Ø³Ø§Ø·ÙŠØ± - Ù…Ø­Ù…Ø¯ Ø¨ÙˆÙ„Ù†ÙˆØ§Ø±</title>
    <style>
        /* --- Ø§Ù„ØªØµÙ…ÙŠÙ… (CSS) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            overflow: hidden;
            background: #0a0a0a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none; /* Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØµØºÙŠØ± */
            height: 100vh;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© */
        .game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            overflow: hidden;
        }

        .speed-lines {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(0deg, transparent 24%, rgba(255,255,255,.05) 25%, rgba(255,255,255,.05) 26%, transparent 27%, transparent 74%, rgba(255,255,255,.05) 75%, rgba(255,255,255,.05) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(255,255,255,.05) 25%, rgba(255,255,255,.05) 26%, transparent 27%, transparent 74%, rgba(255,255,255,.05) 75%, rgba(255,255,255,.05) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
            animation: moveGrid 1s linear infinite;
            opacity: 0.3;
        }

        @keyframes moveGrid {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        .ui-layer {
            position: absolute;
            top: 0;
            width: 100%;
            z-index: 100;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }

        .stats-box {
            background: rgba(0,0,0,0.7);
            border: 2px solid #00f3ff;
            border-radius: 15px;
            padding: 10px 15px;
            color: white;
            text-align: right;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
        }

        .stats-box h3 {
            color: #00f3ff;
            font-size: 0.9rem;
            text-shadow: 0 0 10px #00f3ff;
            margin-bottom: 5px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .speedometer {
            font-size: 2rem;
            color: #00ff66;
            text-shadow: 0 0 20px #00ff66;
            font-family: monospace;
        }

        /* Ø§Ù„Ø³ÙŠØ§Ø±Ø© */
        .car-wrapper {
            position: absolute;
            width: 60px;
            height: 110px;
            z-index: 10;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.8));
            transform-origin: center center;
        }

        .car-body {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffcc00, #ff9900);
            border-radius: 15px;
            position: relative;
            border: 3px solid rgba(255,255,255,0.3);
            transition: background 0.3s;
        }

        .car-body.blue { background: linear-gradient(135deg, #00f3ff, #0099ff); }
        .car-body.red { background: linear-gradient(135deg, #ff0055, #cc0044); }

        .hood-vent {
            position: absolute;
            top: 15px;
            left: 20%;
            width: 60%;
            height: 20px;
            background: rgba(0,0,0,0.4);
            border-radius: 5px;
        }

        .roof {
            position: absolute;
            top: 40px;
            left: 5px;
            width: 50px;
            height: 35px;
            background: #111;
            border-radius: 8px 8px 12px 12px;
            border: 2px solid #333;
        }

        .roof::after {
            content: '';
            position: absolute;
            top: 2px; bottom: 2px; left: 2px; right: 2px;
            background: linear-gradient(45deg, #1a1a1a, #444);
            border-radius: 6px;
        }

        .spoiler {
            position: absolute;
            bottom: 5px;
            left: -5px;
            width: 70px;
            height: 10px;
            background: #333;
            border-radius: 5px;
        }

        .lights-front::before, .lights-front::after {
            content: '';
            position: absolute;
            top: -2px;
            width: 12px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 -20px 40px rgba(255,255,255,0.8);
        }
        .lights-front::before { left: 5px; }
        .lights-front::after { right: 5px; }

        .nitro-flame {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 15px;
            height: 0;
            background: radial-gradient(ellipse at center, #00f3ff 0%, #0099ff 50%, transparent 70%);
            border-radius: 50%;
            opacity: 0;
            filter: blur(5px);
            transition: all 0.2s;
        }
        .nitro-flame.active {
            opacity: 1;
            height: 60px;
            animation: flameFlicker 0.1s infinite;
        }
        @keyframes flameFlicker {
            0%, 100% { height: 55px; }
            50% { height: 65px; }
        }

        /* Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¬Ù…Ø¹ */
        .coin {
            position: absolute;
            width: 35px;
            height: 35px;
            background: radial-gradient(circle, #ffd700, #ffaa00);
            border-radius: 50%;
            border: 3px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            animation: coinSpin 2s linear infinite, coinFloat 1.5s ease-in-out infinite;
            box-shadow: 0 0 20px #ffd700;
            z-index: 5;
        }
        @keyframes coinSpin { 0%, 100% { transform: rotateY(0deg); } 50% { transform: rotateY(180deg); } }
        @keyframes coinFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }

        .powerup {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            animation: pulse 1s infinite;
            z-index: 5;
            border: 2px solid white;
        }
        .powerup.shield { background: linear-gradient(135deg, #00f3ff, #0066ff); }
        .powerup.multi { background: linear-gradient(135deg, #ff00ff, #9900ff); }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }

        /* Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª ÙˆØ§Ù„Ø¢Ø«Ø§Ø± */
        .particle {
            position: absolute;
            background: rgba(255,255,255,0.6);
            border-radius: 50%;
            pointer-events: none;
            animation: fadeOut 1s forwards;
            z-index: 1;
        }
        .skid-mark {
            position: absolute;
            background: rgba(0,0,0,0.4);
            width: 8px; 
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            animation: fadeSkid 3s forwards;
            z-index: 1;
        }
        @keyframes fadeOut { to { opacity: 0; transform: scale(2); } }
        @keyframes fadeSkid { to { opacity: 0; } }

        /* Ø§Ù„ØªØ­ÙƒÙ… */
        .controls-overlay {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 200px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 20px;
            z-index: 200;
        }

        .ctrl-btn {
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-size: 24px;
            backdrop-filter: blur(10px);
            outline: none;
            user-select: none;
            -webkit-user-select: none; /* Safari/Chrome */
            touch-action: manipulation;
            transition: all 0.1s;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ctrl-btn:active {
            transform: scale(0.9);
            background: rgba(255,255,255,0.3);
        }

        .d-pad { display: flex; gap: 20px; margin-bottom: 20px; }
        .left-btn, .right-btn {
            width: 75px; height: 75px;
            background: rgba(0,243,255,0.2); border-color: #00f3ff;
        }

        .pedals { display: flex; flex-direction: column; align-items: flex-end; gap: 15px; margin-bottom: 20px; }
        .nitro-btn {
            width: 60px; height: 60px;
            background: rgba(0,243,255,0.3); border-color: #00f3ff; font-size: 18px; margin-right: 10px;
        }
        .nitro-btn:active { background: #00f3ff; box-shadow: 0 0 30px #00f3ff; }

        .pedal-group { display: flex; gap: 15px; align-items: flex-end; }
        .gas-btn {
            width: 90px; height: 90px;
            background: rgba(0,255,102,0.3); border-color: #00ff66; font-size: 32px;
        }
        .gas-btn:active { background: #00ff66; }

        .brake-btn {
            width: 70px; height: 70px;
            background: rgba(255,0,85,0.3); border-color: #ff0055; font-size: 16px;
        }
        .brake-btn:active { background: #ff0055; }

        /* Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø© */
        .car-select {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 400;
        }
        .car-select h2 {
            color: #00f3ff; font-size: 2rem; margin-bottom: 30px;
            text-shadow: 0 0 20px #00f3ff; text-align: center;
        }
        .car-options { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .car-option {
            background: rgba(255,255,255,0.1);
            border: 2px solid #00f3ff; border-radius: 15px;
            padding: 15px; cursor: pointer;
            transition: all 0.3s; text-align: center;
            min-width: 120px;
        }
        .car-option:hover { transform: scale(1.05); box-shadow: 0 0 20px #00f3ff; }
        .car-option h3 { color: white; font-size: 1rem; margin: 10px 0; }
        .car-option p { color: #aaa; font-size: 0.8rem; }
        .car-preview { width: 60px; height: 100px; margin: 0 auto; position: relative; }
        
    </style>
</head>
<body>

    <div class="car-select" id="carSelect">
        <h2>ğŸï¸ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ù…Ø­Ù…Ø¯ Ø¨ÙˆÙ„Ù†ÙˆØ§Ø± ğŸ<br><span style="font-size:1rem; color:#fff">Ø§Ø®ØªØ± Ø³ÙŠØ§Ø±ØªÙƒ Ù„Ù„Ø¨Ø¯Ø¡</span></h2>
        <div class="car-options">
            <div class="car-option" data-car="yellow">
                <div class="car-preview">
                    <div class="car-wrapper" style="position:static; transform:scale(0.8);">
                        <div class="car-body"><div class="roof"></div></div>
                    </div>
                </div>
                <h3>Ø§Ù„Ø¨Ø±Ù‚ Ø§Ù„Ø°Ù‡Ø¨ÙŠ</h3>
                <p>âš¡ Ù…ØªÙˆØ§Ø²Ù†Ø©</p>
                <p style="color:#00ff66">Ù…Ø¬Ø§Ù†ÙŠØ©</p>
            </div>
            
            <div class="car-option" data-car="blue">
                <div class="car-preview">
                    <div class="car-wrapper" style="position:static; transform:scale(0.8);">
                        <div class="car-body blue"><div class="roof"></div></div>
                    </div>
                </div>
                <h3>Ø§Ù„Ù†ÙŠÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚</h3>
                <p>ğŸš€ Ø³Ø±Ø¹Ø© ÙØ§Ø¦Ù‚Ø©</p>
                <p style="color:yellow">ğŸª™ 50 Ø¹Ù…Ù„Ø©</p>
            </div>
            
            <div class="car-option" data-car="red">
                <div class="car-preview">
                    <div class="car-wrapper" style="position:static; transform:scale(0.8);">
                        <div class="car-body red"><div class="roof"></div></div>
                    </div>
                </div>
                <h3>Ø§Ù„Ø´ÙŠØ·Ø§Ù† Ø§Ù„Ø£Ø­Ù…Ø±</h3>
                <p>ğŸ’ª Ù‚ÙˆØ© Ø®Ø§Ø±Ù‚Ø©</p>
                <p style="color:yellow">ğŸª™ 100 Ø¹Ù…Ù„Ø©</p>
            </div>
        </div>
    </div>

    <div class="ui-layer">
        <div class="stats-box">
            <h3>ğŸ“Š Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© Ù…Ø­Ù…Ø¯</h3>
            <div class="stat-item">ğŸª™ <span id="coins">0</span></div>
            <div class="stat-item">â­ <span id="score">0</span></div>
        </div>
        <div class="stats-box">
            <div class="speedometer"><span id="speedVal">0</span> <span style="font-size:1rem">ÙƒÙ…/Ø³</span></div>
        </div>
    </div>

    <div class="game-container">
        <div class="speed-lines"></div>
        <div id="gameWorld" style="position:absolute;width:100%;height:100%;">
            <div id="skidMarksContainer"></div>
            <div id="coinsContainer"></div>
            <div id="powerupsContainer"></div>
            
            <div class="car-wrapper" id="playerCar">
                <div class="car-body" id="carBody">
                    <div class="spoiler"></div>
                    <div class="roof"></div>
                    <div class="hood-vent"></div>
                    <div class="lights-front"></div>
                    <div class="nitro-flame" id="nitroFlame"></div>
                </div>
            </div>

            <div id="particlesContainer"></div>
        </div>
    </div>

    <div class="controls-overlay">
        <div class="d-pad">
            <button id="btnLeft" class="ctrl-btn left-btn">â—€</button>
            <button id="btnRight" class="ctrl-btn right-btn">â–¶</button>
        </div>
        
        <div class="pedals">
            <button id="btnNitro" class="ctrl-btn nitro-btn">ğŸš€</button>
            <div class="pedal-group">
                <button id="btnBrake" class="ctrl-btn brake-btn">II</button>
                <button id="btnGas" class="ctrl-btn gas-btn">âš¡</button>
            </div>
        </div>
    </div>

    <script>
        // --- ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ± ---
        const car = document.getElementById('playerCar');
        const carBody = document.getElementById('carBody');
        const nitroFlame = document.getElementById('nitroFlame');
        const particlesContainer = document.getElementById('particlesContainer');
        const skidMarksContainer = document.getElementById('skidMarksContainer');
        const coinsContainer = document.getElementById('coinsContainer');
        const powerupsContainer = document.getElementById('powerupsContainer');
        const speedDisplay = document.getElementById('speedVal');
        const coinsDisplay = document.getElementById('coins');
        const scoreDisplay = document.getElementById('score');
        const carSelect = document.getElementById('carSelect');

        // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        let gameData = {
            coins: 0,
            score: 0,
            totalCoins: localStorage.getItem('totalCoins') ? parseInt(localStorage.getItem('totalCoins')) : 0,
            selectedCar: 'yellow',
            shield: false,
            multiplier: 1
        };

        let physics = {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            angle: 0,
            speed: 0,
            maxSpeed: 12,
            maxNitroSpeed: 18,
            acceleration: 0.3,
            friction: 0.96,
            turnSpeed: 4.5
        };

        let controls = { up: false, down: false, left: false, right: false, nitro: false };
        let gameActive = false;
        let coinsArray = [];
        let powerupsArray = [];
        let audioCtx;

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª ---
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'coin') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'nitro') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(50, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø© ---
        document.querySelectorAll('.car-option').forEach(option => {
            option.addEventListener('click', function() {
                initAudio(); // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„
                const carType = this.dataset.car;
                
                if(carType === 'yellow') {
                    startGame('yellow');
                } else if(carType === 'blue') {
                    if (gameData.totalCoins >= 50) {
                        updateTotalCoins(-50);
                        startGame('blue');
                    } else alert('ØªØ­ØªØ§Ø¬ 50 Ø¹Ù…Ù„Ø© Ù„ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©! ğŸª™');
                } else if(carType === 'red') {
                    if (gameData.totalCoins >= 100) {
                        updateTotalCoins(-100);
                        startGame('red');
                    } else alert('ØªØ­ØªØ§Ø¬ 100 Ø¹Ù…Ù„Ø© Ù„ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©! ğŸª™');
                }
            });
        });

        function updateTotalCoins(amount) {
            gameData.totalCoins += amount;
            localStorage.setItem('totalCoins', gameData.totalCoins);
            coinsDisplay.innerText = gameData.totalCoins; // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ
        }

        function startGame(type) {
            gameData.selectedCar = type;
            carBody.className = 'car-body'; 
            if(type === 'blue') {
                carBody.classList.add('blue');
                physics.maxSpeed = 15;
                physics.maxNitroSpeed = 22;
            } else if(type === 'red') {
                carBody.classList.add('red');
                physics.maxSpeed = 18;
                physics.maxNitroSpeed = 25;
                physics.acceleration = 0.5;
            }
            carSelect.style.display = 'none';
            gameActive = true;
            gameLoop();
        }

        // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­ÙƒÙ… ---
        function setupButton(id, key) {
            const btn = document.getElementById(id);
            if(!btn) return;
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… preventDefault Ù„Ù…Ù†Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Øµ Ø£Ùˆ Ø§Ù„ØªÙƒØ¨ÙŠØ±
            btn.addEventListener('touchstart', (e) => { e.preventDefault(); controls[key] = true; }, {passive: false});
            btn.addEventListener('touchend', (e) => { e.preventDefault(); controls[key] = false; }, {passive: false});
            btn.addEventListener('mousedown', () => controls[key] = true);
            btn.addEventListener('mouseup', () => controls[key] = false);
            btn.addEventListener('mouseleave', () => controls[key] = false);
        }

        setupButton('btnGas', 'up');
        setupButton('btnBrake', 'down');
        setupButton('btnLeft', 'left');
        setupButton('btnRight', 'right');
        setupButton('btnNitro', 'nitro');

        // Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        document.addEventListener('keydown', (e) => {
            if(e.key === 'ArrowUp') controls.up = true;
            if(e.key === 'ArrowDown') controls.down = true;
            if(e.key === 'ArrowLeft') controls.left = true;
            if(e.key === 'ArrowRight') controls.right = true;
            if(e.code === 'Space') controls.nitro = true;
        });
        document.addEventListener('keyup', (e) => {
            if(e.key === 'ArrowUp') controls.up = false;
            if(e.key === 'ArrowDown') controls.down = false;
            if(e.key === 'ArrowLeft') controls.left = false;
            if(e.key === 'ArrowRight') controls.right = false;
            if(e.code === 'Space') controls.nitro = false;
        });

        // --- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ---
        function spawnCoin() {
            if(coinsArray.length < 8 && Math.random() < 0.03) {
                const coin = document.createElement('div');
                coin.className = 'coin';
                coin.innerHTML = 'ğŸª™';
                const x = Math.random() * (window.innerWidth - 60) + 30;
                const y = Math.random() * (window.innerHeight - 60) + 30;
                coin.style.left = x + 'px';
                coin.style.top = y + 'px';
                coinsContainer.appendChild(coin);
                coinsArray.push({ el: coin, x: x, y: y });
            }
        }

        function spawnPowerup() {
            if(powerupsArray.length < 1 && Math.random() < 0.005) {
                const type = Math.random() < 0.5 ? 'shield' : 'multi';
                const pDiv = document.createElement('div');
                pDiv.className = 'powerup ' + type;
                pDiv.innerHTML = type === 'shield' ? 'ğŸ›¡ï¸' : 'âš¡';
                const x = Math.random() * (window.innerWidth - 60) + 30;
                const y = Math.random() * (window.innerHeight - 60) + 30;
                pDiv.style.left = x + 'px';
                pDiv.style.top = y + 'px';
                powerupsContainer.appendChild(pDiv);
                powerupsArray.push({ el: pDiv, type: type, x: x, y: y });
            }
        }

        // --- Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª ---
        function createSmoke() {
            if (Math.abs(physics.speed) > 2) {
                const smoke = document.createElement('div');
                smoke.classList.add('particle');
                const rad = (physics.angle + 90) * (Math.PI / 180);
                const offsetX = Math.cos(rad) * 40; 
                const offsetY = Math.sin(rad) * 40;
                smoke.style.left = (physics.x + offsetX) + 'px';
                smoke.style.top = (physics.y + offsetY) + 'px';
                smoke.style.width = Math.random() * 10 + 5 + 'px';
                smoke.style.height = smoke.style.width;
                particlesContainer.appendChild(smoke);
                setTimeout(() => smoke.remove(), 800);
            }
        }

        function createSkidMarks() {
            if (Math.abs(physics.speed) > 6 && (controls.left || controls.right)) {
                const mark = document.createElement('div');
                mark.classList.add('skid-mark');
                mark.style.left = physics.x + 'px';
                mark.style.top = physics.y + 'px';
                mark.style.transform = `rotate(${physics.angle}deg)`;
                skidMarksContainer.appendChild(mark);
                if (skidMarksContainer.children.length > 40) {
                    skidMarksContainer.removeChild(skidMarksContainer.firstChild);
                }
                setTimeout(() => mark.remove(), 2500);
            }
        }

        // --- Ø­Ù„Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        function gameLoop() {
            if(!gameActive) return;

            // Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡
            let currentMax = controls.nitro ? physics.maxNitroSpeed : physics.maxSpeed;
            
            if (controls.nitro && physics.speed > 1) {
                nitroFlame.classList.add('active');
                if(Math.random() < 0.1) playSound('nitro');
                createSmoke();
            } else {
                nitroFlame.classList.remove('active');
            }

            if (controls.up) physics.speed += physics.acceleration;
            else if (controls.down) physics.speed -= 0.5;
            else physics.speed *= physics.friction; // ØªØ¨Ø§Ø·Ø¤ Ø·Ø¨ÙŠØ¹ÙŠ

            // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø±Ø¹Ø©
            if (physics.speed > currentMax) physics.speed = currentMax;
            if (physics.speed < -physics.maxSpeed/2) physics.speed = -physics.maxSpeed/2;
            if (Math.abs(physics.speed) < 0.1) physics.speed = 0;

            // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (Ø§Ù„Ø¯ÙˆØ±Ø§Ù† ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø±ÙƒØ©)
            if (Math.abs(physics.speed) > 0.1) {
                const dir = physics.speed > 0 ? 1 : -1;
                if (controls.left) physics.angle -= physics.turnSpeed * dir;
                if (controls.right) physics.angle += physics.turnSpeed * dir;
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
            const rad = (physics.angle - 90) * (Math.PI / 180);
            physics.x += physics.speed * Math.cos(rad);
            physics.y += physics.speed * Math.sin(rad);

            // Ø§Ù„Ø§Ø±ØªØ¯Ø§Ø¯ Ù…Ù† Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†
            const maxX = window.innerWidth;
            const maxY = window.innerHeight;
            if(physics.x < 25 || physics.x > maxX - 25) {
                physics.speed *= -0.5;
                physics.x = Math.max(25, Math.min(physics.x, maxX - 25));
            }
            if(physics.y < 25 || physics.y > maxY - 25) {
                physics.speed *= -0.5;
                physics.y = Math.max(25, Math.min(physics.y, maxY - 25));
            }

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø³Ù…
            car.style.transform = `translate(${physics.x - 30}px, ${physics.y - 55}px) rotate(${physics.angle}deg)`;
            speedDisplay.innerText = Math.floor(Math.abs(physics.speed) * 10);

            // Ø§Ù„ØªØµØ§Ø¯Ù…Ø§Øª (Ø§Ù„Ø¹Ù…Ù„Ø§Øª)
            for (let i = coinsArray.length - 1; i >= 0; i--) {
                const c = coinsArray[i];
                const dist = Math.sqrt(Math.pow(physics.x - c.x - 17, 2) + Math.pow(physics.y - c.y - 17, 2));
                if(dist < 50) {
                    c.el.remove();
                    coinsArray.splice(i, 1);
                    updateTotalCoins(1);
                    gameData.score += 10 * gameData.multiplier;
                    scoreDisplay.innerText = gameData.score;
                    playSound('coin');
                }
            }

            // Ø§Ù„ØªØµØ§Ø¯Ù…Ø§Øª (Ø§Ù„Ø¨ÙˆÙ†Øµ)
            for (let i = powerupsArray.length - 1; i >= 0; i--) {
                const p = powerupsArray[i];
                const dist = Math.sqrt(Math.pow(physics.x - p.x - 20, 2) + Math.pow(physics.y - p.y - 20, 2));
                if(dist < 50) {
                    p.el.remove();
                    powerupsArray.splice(i, 1);
                    playSound('nitro');
                    if(p.type === 'shield') {
                        car.style.filter = "drop-shadow(0 0 20px #fff)";
                        setTimeout(() => car.style.filter = "", 5000);
                    } else {
                        gameData.multiplier = 2;
                        setTimeout(() => gameData.multiplier = 1, 5000);
                    }
                }
            }

            spawnCoin();
            spawnPowerup();
            createSkidMarks();

            requestAnimationFrame(gameLoop);
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ
        coinsDisplay.innerText = gameData.totalCoins;

    </script>
</body>
</html>
